name: Release by Package Version

on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€
    paths:
      - 'package.json' # åªæœ‰ package.json å‘ç”Ÿå˜åŒ–æ—¶æ‰å°è¯•æ£€æµ‹
  workflow_dispatch: # ä¿ç•™æ‰‹åŠ¨è§¦å‘ä»¥é˜²ä¸‡ä¸€

permissions:
  contents: write # å¿…é¡»æƒé™ï¼šå…è®¸åˆ›å»º Tag å’Œ Release

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ç”Ÿæˆæ—¥å¿—å’Œå¯¹æ¯” Tag

      # --- å…³é”®æ­¥éª¤ï¼šæå–ç‰ˆæœ¬å·å¹¶æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ ---
      - name: Check Version
        id: check
        run: |
          # 1. ä½¿ç”¨ Node è¯»å– package.json çš„ version å­—æ®µ
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "Detected version in package.json: $PACKAGE_VERSION"
          
          # 2. æ‹¼æ¥æˆ Tag æ ¼å¼ (ä¾‹å¦‚ v0.1.1)
          NEW_TAG="v$PACKAGE_VERSION"
          echo "Target Tag: $NEW_TAG"
          
          # 3. æ£€æŸ¥ Git ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ª Tag
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $NEW_TAG already exists. Skipping release."
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… New version detected. Proceeding with release."
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "tag_name=$NEW_TAG" >> $GITHUB_OUTPUT
          fi

      # --- ç¯å¢ƒå‡†å¤‡ (åªæœ‰éœ€è¦å‘å¸ƒæ—¶æ‰æ‰§è¡Œ) ---
      - name: Setup Node.js 22
        if: steps.check.outputs.should_release == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        if: steps.check.outputs.should_release == 'true'
        run: npm ci

      - name: Build project
        if: steps.check.outputs.should_release == 'true'
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      # --- ç”Ÿæˆæ›´æ–°æ—¥å¿— ---
      - name: Generate Changelog
        if: steps.check.outputs.should_release == 'true'
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "## ğŸ“¦ Update Log (${{ steps.check.outputs.tag_name }})" > release_notes.md
          echo "" >> release_notes.md
          
          if [ -z "$PREVIOUS_TAG" ]; then
            git log --pretty=format:"- %s (%h)" >> release_notes.md
          else
            echo "Changes since **$PREVIOUS_TAG**:" >> release_notes.md
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
          fi

      # --- æ‰“åŒ… ---
      - name: Create Archive
        if: steps.check.outputs.should_release == 'true'
        run: |
          FILE_NAME="winefox-bot-webui-${{ steps.check.outputs.tag_name }}-static.zip"
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          
          # æ£€æŸ¥ out ç›®å½•æ˜¯å¦å­˜åœ¨ (Next.js é»˜è®¤å¯¼å‡ºç›®å½•)
          if [ -d "out" ]; then
            echo "âœ… Static export directory 'out' found."
            cd out
            # å°† out ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹æ‰“åŒ…
            zip -r ../$FILE_NAME .
          else
            echo "âŒ Error: 'out' directory not found. Did you set output: 'export' in next.config.mjs?"
            exit 1
          fi

      # --- è‡ªåŠ¨æ‰“ Tag å¹¶å‘å¸ƒ ---
      - name: Create Release
        if: steps.check.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          # è¿™é‡Œä¼šè‡ªåŠ¨åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ Tag
          tag_name: ${{ steps.check.outputs.tag_name }}
          name: Release ${{ steps.check.outputs.tag_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ${{ env.FILE_NAME }}
